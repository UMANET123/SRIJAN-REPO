# Two Factor Authentication

## Index

- [Introduction](#introduction)
- [Dependencies](#dependencies)
- [Handlers](#handlers)
- [Validations](#validations)
- [Implementation Details](#implementation-details)
- [Development, Testing and Production Guide](#development,-testing-and-production-guide)
### Introduction

A Microservice to provide Two Factor Authentication for Globe Telecom numbers.
This service expects a `address` ( Mobile Number ) that belongs to the Philippines, and will generate an OTP (Numerical) which is sent over Email/SMS to the registered user.

The OTP has a 5 min Window after which it will expire

### Dependencies

- Express
- Body Parser
- OTLIB
- Morgan
- Nodemailer

### Handlers

- Generate

Generates an OTP based on the number provided

Note: Make sure the number is from the Philippines

Url

```http
POST /generate
```

Request

```javascript
{
    "address" : "639234567891", // Mobile number
    "email": "testemail@testemail.com" // (OPTIONAL)This is Temp, email will be fetched from ESB and then sent to it
}
```

Response 201

```javascript
{
    "address" : "639234567891", // Mobile Number
    "otp": "1234" // OTP generated
}
```

- Verify

Verifies an OTP which was generated from the step above

URL

```http
POST /verify
```

Request

```javascript
{
    "address": "639234567891", // Mobile Number
    "otp": "1234" // OTP to verify
}
```

Response 200

```javascript
{
    "status": "success"
}
```

Response 200 ( OTP Expired or Wrong OTP )

```javascript
{
    "status": "OTP invalid"
}
```

## Validations

The following validations are performed on the request for both endpoints `/generate` and `/verify` along with the responses

- Check if number belongs to the Philippines, Returns status `400` if number not from the Philippines

```javascript
{
  error: "Address Invalid, does not belong to the Philippines";
}
```

- Check if the number is present, returns status `400` if number not present

```javascript
{
  error: "Address Not present";
}
```

- Check if request method is POST, return `405` if not POST

```javascript
{
  error: "Method not allowed";
}
```

---

OTP validations are only performed on `/verify`.

The following are the cases along with the response

- OTP is not present, will return status `400` if OTP not present

```javascript
{
  error: "OTP is not present";
}
```

- OTP length is Greater or Less than `6`, will return status `400` if OTP length is Greater or Less than `6`

```javascript
{
  error: "OTP length Mismatch";
}
```

- OTP is alphanumeric, will return status `400` if OTP is alphanumeric

```javascript
{
  error: "OTP should be numbers only";
}
```

## Implementation Details

A Secret is generated by calling

```javascript
const secret = optlib.authenticator.generateSecret();
```

And to generate an OTP, we append the `address` with the `secret`, to verify also, we append the `address` with the `secret`

The OTP is short lived, only for `5mins` ( minutes )

## Development, Testing and Production Guide

The following is broken down into 3 parts

- Development
- Testing
- Deployment

Before getting started, please make sure you have installed the following packages on your system and on the production server

- Docker
- Docker Compose

### Development

- Build The docker-compose images

```bash
$ docker-compose build
```

- Run the docker-compose containers

```bash
$ docker-compose up
```

- Stop the containers

```bash
$ docker-compose down
```

### Testing

- Build the docker-compose images

```bash
$ docker-compose build
```

- Run the docker-compose containers with the test environment

```bash
$ docker-compose -f docker-compose.yml -f testing-docker-compose.yml up
```

- Stop the containers

```bash
$ docker-compose down
```

### Production

- Build the docker-compose images

```bash
$ docker-compose build
```

- Run the docker-compose container with the production environment

```bash
$ docker-compose -f docker-compose.yml -f production-docker-compose.yml up -d
```

- Stop the containers

```bash
$ docker-compose down
```

---

Note : Each environment has it's own docker-compose file, this contains all the required environment variables required for that environment
